syntax = "proto3";

package khaleesi.core.sawmill;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "core.proto";


message ResponseMetadata {
  google.protobuf.Timestamp logged_timestamp = 1;
  string                    errors           = 2;
  string                    pod_id           = 3;
}


message Event {

  message Target {
    string             type  = 1;
    string             id    = 2;
    khaleesi.core.User owner = 3;
  }

  message Action {
    enum ActionType {
      // Special.
      UNKNOWN_ACTION = 0;
      CUSTOM         = 1;

      // CRUD.
      CREATE         = 10;
      READ           = 11;
      UPDATE         = 12;
      DELETE         = 13;

      // Processes.
      START          = 20;
      END            = 21;
    }

    enum ResultType {
      UNKNOWN_RESULT = 0;
      SUCCESS        = 1;
      WARNING        = 2;
      ERROR          = 3;
      FATAL          = 4;
    }

    ActionType crud_type   = 1;
    string     custom_type = 2;
    ResultType result      = 3;
    string     details     = 4;
  }

  khaleesi.core.RequestMetadata request_metadata = 1;
  Target                        target           = 2;
  Action                        action           = 3;
}


message Request {
  khaleesi.core.RequestMetadata   request_metadata = 1;
  khaleesi.core.GrpcCallerDetails upstream_request = 2;
}

message Error {
  khaleesi.core.RequestMetadata request_metadata = 1;
  string                        status           = 2;
  string                        loglevel         = 3;
  string                        gate             = 4;
  string                        service          = 5;
  string                        public_key       = 6;
  string                        public_details   = 7;
  string                        private_message  = 8;
  string                        private_details  = 9;
  string                        stacktrace       = 10;
}


message Response {
  string                    status     = 2;
  google.protobuf.Timestamp timestamp  = 3;
}

message ResponseRequest {
  string   request_id = 1;
  Response response   = 2;
}


message LogStandardResponse {}

service Lumberjack {
  rpc LogEvent    (Event)           returns (LogStandardResponse);
  rpc LogRequest  (Request)         returns (LogStandardResponse);
  rpc LogResponse (ResponseRequest) returns (LogStandardResponse);
  rpc LogError    (Error)           returns (LogStandardResponse);
}


message EventResponse {
  ResponseMetadata event_metadata = 1;
  Event            event          = 2;
}

message EventsList {
  repeated EventResponse events = 1;
}


message RequestResponse {
  ResponseMetadata         request_metadata  = 1;
  Request                  request           = 2;
  ResponseMetadata         response_metadata = 3;
  Response                 response          = 4;
  google.protobuf.Duration reported_duration = 10;
  google.protobuf.Duration logged_duration   = 11;
}

message RequestList {
  repeated RequestResponse requests = 1;
}

message ErrorResponse {
  ResponseMetadata error_metadata = 1;
  Error            error          = 2;
}

message ErrorList {
  repeated ErrorResponse errors = 1;
}


message LogFilter {

}

service Sawyer {
  rpc GetEvents   (LogFilter) returns (EventsList);
  rpc GetRequests (LogFilter) returns (RequestList);
  rpc GetErrors   (LogFilter) returns (ErrorList);
}

message EmptyRequest {
  khaleesi.core.RequestMetadata   request_metadata = 1;
}

message CallData {
  khaleesi.core.GrpcCallerDetails          call      = 1;
  repeated khaleesi.core.GrpcCallerDetails calls     = 2;
  repeated khaleesi.core.GrpcCallerDetails called_by = 3;
}

message ServiceCallData {
  repeated CallData call_list = 1;
}

service Forester {
  rpc GetServiceCallData (EmptyRequest) returns (ServiceCallData);
}
