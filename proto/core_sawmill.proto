syntax = "proto3";

package khaleesi.core.sawmill;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "core.proto";


message ResponseMetadata {
  google.protobuf.Timestamp logged_timestamp = 1;
  string                    errors           = 2;
  string                    pod_id           = 3;
}


message Event {

  message Target {
    string             type  = 1;
    string             id    = 2;
    khaleesi.core.User owner = 3;
  }

  message Action {
    enum ActionType {
      // Special.
      UNKNOWN_ACTION = 0;
      CUSTOM         = 1;

      // CRUD.
      CREATE         = 10;
      READ           = 11;
      UPDATE         = 12;
      DELETE         = 13;

      // Processes.
      START          = 20;
      END            = 21;
    }

    enum ResultType {
      UNKNOWN_RESULT = 0;
      SUCCESS        = 1;
      WARNING        = 2;
      ERROR          = 3;
      FATAL          = 4;
    }

    ActionType crud_type   = 1;
    string     custom_type = 2;
    ResultType result      = 3;
    string     details     = 4;
  }

  khaleesi.core.RequestMetadata request_metadata   = 1;
  Target                        target             = 2;
  Action                        action             = 3;
  bool                          logger_send_metric = 10;
}


message BackgateRequest {
  // Metadata.
  khaleesi.core.RequestMetadata request_metadata = 1;

  // khaleesi.ninja.
  string language  = 10;
  string device_id = 11;

  // HTTP.
  string language_header = 20;
  string ip              = 21;
  string useragent       = 22;
}

message Request {
  khaleesi.core.RequestMetadata   request_metadata = 1;
  khaleesi.core.GrpcCallerDetails upstream_request = 2;
}

message Query {
  string id         = 1;
  string raw        = 2;

  google.protobuf.Timestamp start = 10;
  google.protobuf.Timestamp end   = 11;
}

message Queries {
  khaleesi.core.RequestMetadata request_metadata = 1;
  repeated Query                queries          = 2;
}

message Error {
  khaleesi.core.RequestMetadata request_metadata = 1;
  string                        status           = 2;
  string                        loglevel         = 3;
  string                        gate             = 4;
  string                        service          = 5;
  string                        public_key       = 6;
  string                        public_details   = 7;
  string                        private_message  = 8;
  string                        private_details  = 9;
  string                        stacktrace       = 10;
}


message Response {
  string                    status     = 1;
  google.protobuf.Timestamp timestamp  = 2;
}

message BackgateResponseRequest {
  string         backgate_request_id = 1;
  Response       response            = 2;
}

message ResponseRequest {
  string   request_id = 1;
  Response response   = 2;
}


message LogStandardResponse {}

service Lumberjack {
  rpc LogEvent                   (Event)                   returns (LogStandardResponse);
  rpc LogRequest                 (Request)                 returns (LogStandardResponse);
  rpc LogResponse                (ResponseRequest)         returns (LogStandardResponse);
  rpc LogError                   (Error)                   returns (LogStandardResponse);
  rpc LogBackgateRequest         (BackgateRequest)         returns (LogStandardResponse);
  rpc LogSystemBackgateRequest   (EmptyRequest)            returns (LogStandardResponse);
  rpc LogBackgateRequestResponse (BackgateResponseRequest) returns (LogStandardResponse);
}


message EventResponse {
  ResponseMetadata event_metadata = 1;
  Event            event          = 2;
}

message EventsList {
  repeated EventResponse events = 1;
}

message QueryResponse {
  khaleesi.core.RequestMetadata query_request_metadata  = 1;
  ResponseMetadata              query_response_metadata = 2;
  Query                         query                   = 3;

  string                   normalized        = 10;
  repeated string          tables            = 11;
  repeated string          columns           = 12;
  google.protobuf.Duration reported_duration = 20;

}

message QueryList{
  repeated QueryResponse queries = 1;
}


message ProcessedResponse {
  google.protobuf.Duration reported_duration = 1;
  google.protobuf.Duration logged_duration   = 2;
}


message BackgateRequestResponse {
  ResponseMetadata request_metadata  = 1;
  BackgateRequest  request           = 2;
  ResponseMetadata response_metadata = 3;
  Response         response          = 4;

  enum RequestType {
    UNKNOWN = 0;
    USER    = 1;
    SYSTEM  = 2;
  }

  // Processed data.
  RequestType              type               = 10;
  ProcessedResponse        processed_response = 11;
  string                   geolocation        = 20;
  string                   browser            = 21;
  string                   rendering_agent    = 22;
  string                   os                 = 23;
  string                   device_type        = 24;
}

message BackgateRequestList {
  repeated BackgateRequestResponse requests = 1;
}


message RequestResponse {
  ResponseMetadata         request_metadata   = 1;
  Request                  request            = 2;
  ResponseMetadata         response_metadata  = 3;
  Response                 response           = 4;
  ProcessedResponse        processed_response = 5;
}

message RequestList {
  repeated RequestResponse requests = 1;
}

message ErrorResponse {
  ResponseMetadata error_metadata = 1;
  Error            error          = 2;
}

message ErrorList {
  repeated ErrorResponse errors = 1;
}


message LogFilter {
  khaleesi.core.RequestMetadata request_metadata = 1;
}

service Sawyer {
  rpc GetEvents           (LogFilter) returns (EventsList);
  rpc GetRequests         (LogFilter) returns (RequestList);
  rpc GetErrors           (LogFilter) returns (ErrorList);
  rpc GetBackgateRequests (LogFilter) returns (BackgateRequestList);
}

message EmptyRequest {
  khaleesi.core.RequestMetadata   request_metadata = 1;
}

message CallData {
  khaleesi.core.GrpcCallerDetails          call      = 1;
  repeated khaleesi.core.GrpcCallerDetails calls     = 2;
  repeated khaleesi.core.GrpcCallerDetails called_by = 3;
}

message ServiceCallData {
  repeated CallData call_list = 1;
}

service Forester {
  rpc GetServiceCallData (EmptyRequest) returns (ServiceCallData);
}
