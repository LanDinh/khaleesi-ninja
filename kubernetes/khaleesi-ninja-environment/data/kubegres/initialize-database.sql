CREATE FUNCTION pg_temp.assert_permissions(serviceUser text, database text) RETURNS VOID AS $$
BEGIN
  EXECUTE FORMAT('DROP SCHEMA IF EXISTS public');
  EXECUTE FORMAT('CREATE SCHEMA IF NOT EXISTS khaleesi');

  EXECUTE FORMAT('GRANT CONNECT ON DATABASE %I TO %I', database, serviceUser);
  EXECUTE FORMAT('GRANT USAGE ON SCHEMA khaleesi TO %I', serviceUser);

  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT SELECT ON TABLES TO %I', serviceUser);
  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT INSERT ON TABLES TO %I', serviceUser);
  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT UPDATE ON TABLES TO %I', serviceUser);
  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT DELETE ON TABLES TO %I', serviceUser);
  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT REFERENCES ON TABLES TO %I', serviceUser);
  EXECUTE FORMAT('ALTER DEFAULT PRIVILEGES IN SCHEMA khaleesi GRANT USAGE ON SEQUENCES TO %I', serviceUser);
END
$$ LANGUAGE plpgsql;


-- noinspection SyntaxError,SqlSignature
SELECT pg_temp.assert_permissions(:'serviceUser', :'database');
